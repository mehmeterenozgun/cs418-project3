<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>QR Crop Debug & Latency</title>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <style>
    body { font-family:sans-serif; margin:1em; }
    video { width:100%; max-width:640px; background:#000; }
    #latency { font-weight:bold; }
    #debug { border:2px solid red; margin-top:10px; }
  </style>
</head>
<body>
  <h1>Debug QR Crop + Latency</h1>
  <video id="video" controls crossorigin="anonymous"></video>
  <p>Measured latency: <span id="latency">-</span> ms</p>
  <!-- debug canvas shows exactly what we're feeding to jsQR -->
  <canvas id="debug" width="128" height="128"></canvas>

  <script>
    // 1) Initialize DASH
    const video  = document.getElementById('video');
    const player = dashjs.MediaPlayer().create();
    player.initialize(video, '/ldash/1.mpd', true);

    // 2) Setup offscreen + debug canvases
    const qrSize   = 128;
    const margin   = 10; // how far in from bottom/right
    const off      = document.createElement('canvas');
    off.width = off.height = qrSize;
    const offCtx   = off.getContext('2d');

    const debug    = document.getElementById('debug');
    const dbgCtx   = debug.getContext('2d');
    const display  = document.getElementById('latency');

    // 3) Poll & crop at 10Hz
    setInterval(() => {
      if (video.readyState < 2) return; // HAVE_CURRENT_DATA

      // compute bottom-right source coordinates
      const sx = video.videoWidth  - qrSize - margin;
      const sy = video.videoHeight - qrSize - margin;

      console.log('Cropping from:', sx, sy, qrSize, qrSize);

      // draw to offscreen for jsQR
      offCtx.drawImage(video, sx, sy, qrSize, qrSize, 0, 0, qrSize, qrSize);
      // draw to visible debug canvas
      dbgCtx.clearRect(0, 0, qrSize, qrSize);
      dbgCtx.drawImage(video, sx, sy, qrSize, qrSize, 0, 0, qrSize, qrSize);

      const img  = offCtx.getImageData(0, 0, qrSize, qrSize);
      const code = jsQR(img.data, qrSize, qrSize);

      if (code && code.data) {
        const sentTs   = parseInt(code.data, 10);
        const latency  = Date.now() - sentTs;
        display.textContent = latency;
      }
    }, 100);
  </script>
</body>
</html>
